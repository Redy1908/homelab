---
- name: Install and configure Headscale
  hosts: vps
  become: true
  vars:
    headscale_url: "{{ lookup('env', 'HEADSCALE_URL') }}"
    headscale_base_domain: "{{ lookup('env', 'HEADSCALE_BASE_DOMAIN') }}"
    tls_letsencrypt_hostname: "{{ lookup('env', 'TLS_LETSENCRYPT_HOSTNAME') }}"
    headscale_deb_url: "https://github.com/juanfont/headscale/releases/download/v0.27.1/headscale_0.27.1_linux_amd64.deb"
    config_src: "{{ playbook_dir }}/config.yaml"
    config_dest: "/etc/headscale/config.yaml"
  tasks:
    - name: Download Headscale .deb package
      get_url:
        url: "{{ headscale_deb_url }}"
        dest: /tmp/headscale.deb
    - name: Install Headscale package
      apt:
        deb: /tmp/headscale.deb
        state: present
    - name: Ensure /etc/headscale directory exists
      file:
        path: /etc/headscale
        state: directory
        mode: "0755"
    - name: Copy Headscale config.yaml
      template:
        src: "{{ config_src }}"
        dest: "{{ config_dest }}"
        owner: root
        group: root
        mode: "0644"
      notify: Restart Headscale
    - name: Enable and start Headscale service
      systemd:
        name: headscale
        enabled: true
        state: started
    - name: Check Headscale service status
      systemd:
        name: headscale
      register: headscale_status
    - name: Show Headscale service status
      debug:
        var: headscale_status
  handlers:
    - name: Restart Headscale
      systemd:
        name: headscale
        state: restarted
